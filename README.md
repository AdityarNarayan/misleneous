
' Code Generated by Sidekick is for learning and experimentation purposes only.
Sub GetTop5BeneficiariesPerCaseCategory_CustomCols()
    Dim wsData As Worksheet, wsOut As Worksheet
    Dim lastRow As Long, outRow As Long
    Dim dict As Object, key As String
    Dim arrData, arrTemp, arrOut
    Dim i As Long, j As Long
    Dim caseCatDict As Object
    Dim tempList As Object
    
    Set wsData = ThisWorkbook.Sheets("Data")
    On Error Resume Next
    Set wsOut = ThisWorkbook.Sheets("Top5Beneficiaries")
    If wsOut Is Nothing Then
        Set wsOut = ThisWorkbook.Sheets.Add(After:=wsData)
        wsOut.Name = "Top5Beneficiaries"
    Else
        wsOut.Cells.Clear
    End If
    On Error GoTo 0
    
    lastRow = wsData.Cells(wsData.Rows.Count, 42).End(xlUp).Row ' Column AP for last row
    arrData = wsData.Range("A1:AP" & lastRow).Value
    
    Set caseCatDict = CreateObject("Scripting.Dictionary")
    
    ' Group data by Case_ID + Category
    For i = 2 To UBound(arrData)
        key = arrData(i, 41) & "|" & arrData(i, 12) ' Case_ID (AO) | Category (L)
        If Not caseCatDict.Exists(key) Then
            Set tempList = CreateObject("System.Collections.ArrayList")
            caseCatDict.Add key, tempList
        Else
            Set tempList = caseCatDict(key)
        End If
        tempList.Add Array(arrData(i, 42), arrData(i, 12), arrData(i, 41), arrData(i, 11)) ' Beneficiary(AP), Category(L), Case_ID(AO), Credit(K)
    Next i
    
    ' Output headers
    wsOut.Range("A1:D1").Value = Array("Beneficiary Name", "Category", "Case_ID", "Credit")
    outRow = 2
    
    ' For each group, sort and take top 5
    For Each key In caseCatDict.Keys
        Set tempList = caseCatDict(key)
        ' Sort by Credit descending
        tempList.Sort Function(a, b)
            If a(3) = b(3) Then
                GetTop5BeneficiariesPerCaseCategory_CustomCols = 0
            ElseIf a(3) < b(3) Then
                GetTop5BeneficiariesPerCaseCategory_CustomCols = 1
            Else
                GetTop5BeneficiariesPerCaseCategory_CustomCols = -1
            End If
        End Function
        
        ' Output top 5
        For j = 0 To Application.Min(4, tempList.Count - 1)
            wsOut.Range("A" & outRow & ":D" & outRow).Value = tempList(j)
            outRow = outRow + 1
        Next j
    Next key
    
    wsOut.Columns.AutoFit
    MsgBox "Top 5 Beneficiaries per Case_ID and Category extracted!"
End Sub
